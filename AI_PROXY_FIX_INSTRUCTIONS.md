# üîß AI Proxy Fix - Max Tokens Issue

## –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ–ª—É—á–∞–ª–∏ –æ—à–∏–±–∫—É: `Invalid max_tokens value` –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è AI –∞–≥–µ–Ω—Ç–æ–≤.

## –ü—Ä–∏—á–∏–Ω–∞

DirectAIService –æ—Ç–ø—Ä–∞–≤–ª—è–ª `maxTokens: 4096`, –Ω–æ AI proxy —Ñ—É–Ω–∫—Ü–∏—è –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–ª–∞ –º–∞–∫—Å–∏–º—É–º –¥–æ 4000.

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. ‚úÖ DirectAIService - —É–º–µ–Ω—å—à–∏–ª maxTokens

```typescript
// –ë—ã–ª–æ: maxTokens: 4096
// –°—Ç–∞–ª–æ: maxTokens: 4000
```

### 2. ‚úÖ AI Proxy - —É–ª—É—á—à–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è

```typescript
// –î–æ–±–∞–≤–ª–µ–Ω—ã –ª–∏–º–∏—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞:
const maxTokensLimits = {
  openai: 4096,
  anthropic: 4096,
  gemini: 8192,
};
```

### 3. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ configuration errors

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±–æ–≥–æ AI –∞–≥–µ–Ω—Ç–∞
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –Ω–µ—Ç –æ—à–∏–±–æ–∫ `Invalid max_tokens value`

### –¢–µ—Å—Ç —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç

```bash
node test-ai-fix.js
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard ‚Üí Logs
2. –ù–∞–π–¥–∏—Ç–µ –ª–æ–≥–∏ —Ñ—É–Ω–∫—Ü–∏–∏ `ai-proxy`
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∏–¥–∏—Ç–µ –ª–æ–≥–∏ —Ç–∏–ø–∞:
   ```
   Processing AI request: {
     provider: "anthropic",
     model: "claude-3-5-sonnet-20241022",
     max_tokens: 4000,
     ...
   }
   ```

## –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### ‚úÖ –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```
POST /functions/v1/ai-proxy 400 (Bad Request)
Error: Invalid max_tokens value
```

### ‚úÖ –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```
POST /functions/v1/ai-proxy 200 (OK)
AI –∞–≥–µ–Ω—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–ë–æ–ª–µ–µ –≥–∏–±–∫–∏–µ –ª–∏–º–∏—Ç—ã** - –∫–∞–∂–¥—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä —Ç–µ–ø–µ—Ä—å –∏–º–µ–µ—Ç —Å–≤–æ–π –ª–∏–º–∏—Ç
2. **–õ—É—á—à–µ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–ø—Ä–æ—Å–∞—Ö –∏ –æ—à–∏–±–∫–∞—Ö
3. **–°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** - configuration errors –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ

## –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ Supabase Dashboard
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ edge —Ñ—É–Ω–∫—Ü–∏—è `ai-proxy` –æ–±–Ω–æ–≤–ª–µ–Ω–∞
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –æ—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Network tab –≤ DevTools –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—à–∏–±–∫–∞—Ö
