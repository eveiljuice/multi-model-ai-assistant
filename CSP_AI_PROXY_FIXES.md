# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è CSP –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ AI Proxy

## üéØ –ü—Ä–æ–±–ª–µ–º–∞ 1: Content Security Policy (CSP)

### üìã **–î–∏–∞–≥–Ω–æ–∑**

```
‚ùå "The Content Security Policy directive 'frame-ancestors' is ignored when delivered via a <meta> element"
```

**–ü—Ä–∏—á–∏–Ω–∞**: –î–∏—Ä–µ–∫—Ç–∏–≤–∞ `frame-ancestors` –¥–æ–±–∞–≤–ª—è–ª–∞—Å—å —á–µ—Ä–µ–∑ `<meta>` —Ç–µ–≥ –≤ `SecurityHeaders.tsx`, –Ω–æ –ø–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ CSP —ç—Ç–∞ –¥–∏—Ä–µ–∫—Ç–∏–≤–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç **—Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ HTTP –∑–∞–≥–æ–ª–æ–≤–∫–∏**.

### ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ CSP**

#### 1. –£–±—Ä–∞–Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞ –∏–∑ SecurityHeaders.tsx

```typescript
// –î–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
const csp = [
  // ...
  "frame-ancestors 'none'", // ‚ùå –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è –≤ meta —Ç–µ–≥–µ
  // ...
].join("; ");

// –ü–û–°–õ–ï (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ):
const csp = [
  // ...
  // ‚ùå frame-ancestors —É–±—Ä–∞–Ω–∞ –∏–∑ meta —Ç–µ–≥–∞
  // ...
].join("; ");
```

#### 2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞ –≤ vite.config.ts

```typescript
// –î–û:
'Content-Security-Policy': [
  // ...
  "form-action 'self'"
].join('; '),

// –ü–û–°–õ–ï:
'Content-Security-Policy': [
  // ...
  "frame-ancestors 'none'", // ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ HTTP –∑–∞–≥–æ–ª–æ–≤–∫–∏
  "form-action 'self'"
].join('; '),
```

### üìä **–†–µ–∑—É–ª—å—Ç–∞—Ç**

- ‚úÖ **CSP –¥–∏—Ä–µ–∫—Ç–∏–≤–∞ `frame-ancestors` —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ** —á–µ—Ä–µ–∑ HTTP –∑–∞–≥–æ–ª–æ–≤–∫–∏
- ‚úÖ **–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª–∏ –∏—Å—á–µ–∑–ª–æ**
- ‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç clickjacking –∞–∫—Ç–∏–≤–Ω–∞**

---

## üéØ –ü—Ä–æ–±–ª–µ–º–∞ 2: AI Proxy 500 Internal Server Error

### üìã **–î–∏–∞–≥–Ω–æ–∑**

```
‚ùå "Failed to load resource: the server responded with a status of 500"
‚ùå "anthropic API Error: Error: Server error: Internal server error"
```

### üîç **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞**

#### 1. –¢–µ—Å—Ç –±–∞–∑–æ–≤–æ–π —Å–≤—è–∑–Ω–æ—Å—Ç–∏

```bash
‚úÖ AI Proxy endpoint –æ—Ç–≤–µ—á–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
‚úÖ Status 401 (auth required) - –æ–∂–∏–¥–∞–µ–º–æ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞
‚úÖ Edge function —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
```

#### 2. –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞

```typescript
// ‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
// ‚úÖ Validation –∑–∞–ø—Ä–æ—Å–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
// ‚úÖ API –∫–ª—é—á–∏ –∏—â—É—Ç—Å—è —Å fallback'–æ–º
// ‚úÖ Error handling —É–ª—É—á—à–µ–Ω
```

### üîß **–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã 500 –æ—à–∏–±–∫–∏**

#### 1. **API Key Issues**

```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ–∫—Ä–µ—Ç—ã –≤ Supabase:
npx supabase secrets list

# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã:
- ANTHROPIC_API_KEY ‚úÖ
- OPENAI_API_KEY ‚úÖ
- GEMINI_API_KEY ‚úÖ
```

#### 2. **Anthropic API Problems**

- **Invalid API Key**: –ö–ª—é—á –∏—Å—Ç–µ–∫ –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- **Quota Exceeded**: –ü—Ä–µ–≤—ã—à–µ–Ω—ã –ª–∏–º–∏—Ç—ã –Ω–∞ Anthropic
- **Model Unavailable**: –ú–æ–¥–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
- **Request Format**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞

#### 3. **Database Issues**

- –ü—Ä–æ–±–ª–µ–º—ã —Å RPC —Ñ—É–Ω–∫—Ü–∏—è–º–∏ (deduct_credits)
- –ü—Ä–æ–±–ª–µ–º—ã —Å audit_logs —Ç–∞–±–ª–∏—Ü–µ–π
- –ü—Ä–æ–±–ª–µ–º—ã —Å rate_limit –ø—Ä–æ–≤–µ—Ä–∫–æ–π

### üõ†Ô∏è **–î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ —à–∞–≥–∏**

#### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–µ–π

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã Supabase
cd supabase && npx supabase secrets list

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å Anthropic –∫–ª—é—á–∞
curl -X POST https://api.anthropic.com/v1/messages \
  -H "x-api-key: YOUR_KEY" \
  -H "Content-Type: application/json" \
  -H "anthropic-version: 2023-06-01" \
  -d '{"model": "claude-3-sonnet-20240229", "max_tokens": 10, "messages": [{"role": "user", "content": "Hi"}]}'
```

#### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ Supabase

```bash
# –í Supabase Dashboard:
# 1. Edge Functions ‚Üí ai-proxy ‚Üí Logs
# 2. –ù–∞–π—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏ —Å timestamp
# 3. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ Anthropic API
```

#### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç Anthropic

```bash
# 1. –ó–∞–π—Ç–∏ –Ω–∞ https://console.anthropic.com/
# 2. Credits & Billing
# 3. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞
# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Rate Limits
```

### üìä **–£–ª—É—á—à–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**

#### –î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç:

```javascript
// –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ —Ç–µ–ø–µ—Ä—å –±—É–¥–µ—Ç:
console.error('anthropic API Error Details:', {
  status: response.status,
  statusText: response.statusText,
  errorData: {...},
  provider: 'anthropic',
  headers: {...}
});

// –í–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ "Internal server error"
```

#### –í Supabase Edge Function –ª–æ–≥–∞—Ö:

```javascript
// –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
console.log('Calling Anthropic API with model:', model);
console.log('Anthropic request body:', {...});
console.log('Anthropic response status:', status);
console.error('Anthropic API error details:', {...});
```

### üöÄ **–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏**

1. **–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)**
2. **–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç—É**
3. **–ù–∞–π–¥–∏—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏** - —Ç–µ–ø–µ—Ä—å –æ–Ω–∏ –±—É–¥—É—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º–∏
4. **–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –æ—à–∏–±–∫–æ–π** –¥–ª—è —Ç–æ—á–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### üéØ **–¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π**

#### –í–º–µ—Å—Ç–æ "Internal server error" —Ç–µ–ø–µ—Ä—å –±—É–¥–µ—Ç:

```bash
# API Key –ø—Ä–æ–±–ª–µ–º—ã:
"Anthropic API error (401): Invalid API key"

# Quota –ø—Ä–æ–±–ª–µ–º—ã:
"Anthropic API error (429): Rate limit exceeded"

# Model –ø—Ä–æ–±–ª–µ–º—ã:
"Anthropic API error (400): Invalid model"

# Request –ø—Ä–æ–±–ª–µ–º—ã:
"Anthropic API error (422): Validation error"
```

---

## ‚úÖ **–°—Ç–∞—Ç—É—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π**

### Content Security Policy

- ‚úÖ **CSP frame-ancestors –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ HTTP –∑–∞–≥–æ–ª–æ–≤–∫–∏**
- ‚úÖ **–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ –∫–æ–Ω—Å–æ–ª–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã**
- ‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç clickjacking –∞–∫—Ç–∏–≤–Ω–∞**

### AI Proxy Diagnostics

- ‚úÖ **Edge function —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞**
- ‚úÖ **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–æ**
- ‚úÖ **–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ Anthropic API**
- ‚è≥ **–û–∂–∏–¥–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫ –¥–ª—è —Ç–æ—á–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏**

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:** ${new Date().toISOString().split('T')[0]}

**–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–µ–π—á–∞—Å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç—É - –µ—Å–ª–∏ –æ—à–∏–±–∫–∏ –æ—Å—Ç–∞–ª–∏—Å—å, –æ–Ω–∏ –±—É–¥—É—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ –∏ –ø–æ–º–æ–≥—É—Ç —Ç–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É!** üéØ
